```{r, echo = FALSE}
library(raster)
library(dplyr)
library(ggplot2)
library(metafor)
library(nlme)
library(gridExtra)
library(broom)

source('02_functions.R')

fl_combined <- readr::read_csv("Data_outputs/fl_combined.csv")

event <- filter(fl_combined, Event == 'Yes')
no_event <- filter(fl_combined, Event != 'Yes')

```

The log ratio is the natural logarithm of the proportion of change in species richness (ln(final richness / initial richness)). We calculate the percent change in species richness as exp(log ratio) = final richness / initial richness. 

```{r, echo = FALSE, eval = FALSE}
# Log ratio reference for me
# When there is no change in richness, final / initial = 1
log(1) = 0

# Example: 50% increase in richness between time points
# When richness increases over time, final / initial > 1
log(150 / 100)
0.4054651
# Percent change = exp(log ratio) - 1
exp(0.4054651) - 1

# Example: 50% decrease in richness between time points
# When richness decreases over time, final / initial < 1
log(50 / 100)
[1] -0.6931472
# Percent change = exp(log ratio) - 1
exp(-0.6931472) - 1
```

To test whether local marine species richness has changed over time, we have performed a meta-regression on the relationship between the log ratio of species richness between the final and initial time points and study duration. The weighted analysis included 213 sites and 50 studies while the unweighted analysis included 505 sites and 122 studies.  

In the both the weighted and unweighted analyses, species richness did not change on average (mod1, mod2), nor was there a relationship between change in species richness and duration (mod1).

```{r}
# Weighted analysis - and naive model plot
mod1 <- 
  rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM, 
         data = filter(fl_combined, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                       vi.SppR.ROM > 0),
         random = ~ 1 | as.factor(Study.ID), 
         mods = ~ Duration)
mod1

mod2 <- 
  rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM, 
         data = filter(fl_combined, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                       vi.SppR.ROM > 0),
          random = ~ 1 | as.factor(Study.ID))
mod2

# Unweighted analysis that includes all of the log ratios that do not have 
# variance associated with them. 
lme1 <- lme(yi.SppR.ROM ~ Duration, random = ~ 1 | Study.ID, data = fl_combined, 
            na.action = na.omit)
summary(lme1)
```

Looking at the caterpillar plot for each of the studies, it is probably best to keep Study.ID as a random effect.

```{r, echo = FALSE, eval = FALSE}
# something is wrong with this plot righ tnow
lattice::dotplot(ranef(lme1, condVar=TRUE), cex = 0.5, scales=list(cex=0.4))
```

```{r, fig.height=7.5, fig.width=6.7}
duration_w <- 
filter(fl_combined, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & vi.SppR.ROM > 0) %>%
ggplot(data = ., aes(x = Duration, y = yi.SppR.ROM, colour = as.factor(Study.ID))) +
  geom_point(size = 1) + 
  ylab('Log Ratio') +
  theme_bw() +
  theme(legend.position = 'none') +
  geom_hline(yintercept = 0, colour = 'red', linetype = 'dashed') +
  ggtitle('Weighted Analysis') + 
  xlab('Duration (years)') #+
  #ylim(-2, 2)

duration_uw <- 
filter(fl_combined, !is.na(yi.SppR.ROM)) %>%
ggplot(data = ., aes(x = Duration, y = yi.SppR.ROM, colour = as.factor(Study.ID))) +
  geom_point(size = 1) + 
  ylab('Log Ratio') +
  theme_bw() +
  theme(legend.position = 'none') +
  geom_hline(yintercept = 0, colour = 'red', linetype = 'dashed') +
  ggtitle('Unweighted Analysis') + 
  xlab('Duration (years)') #+
  #ylim(-3, 3)

grid.arrange(duration_w, duration_uw, nrow = 2)

```

Both the weighted and unweighted naive models, where duration is the only predictor, show no significant change in species richness on average.  

In the short term, negative and uncertain events were associated with increases in species richness. On average this was increase was 39% and 32% for a study associated with a positive and uncertain event, respectively.

Long term? Studies associated with events expected to be positive or uncertain were found to have a decline in richess? 5 - 1% per year? This doesn't make a ton of sense.

```{r}
# Confirm that the events are being matched with the data properly #
localmod <- 
  rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM, data = event,
         random = ~ 1 | factor(Study.ID),
         mods = ~ Duration:expected_change + expected_change + 0)
localmod

get_percent_change(localmod$b)

ggplot(data = event, aes(x = Duration, y = yi.SppR.ROM)) + 
  geom_point(aes(colour = expected_change)) + 
#  ylim(c(-2.1, 2.1)) + 
  stat_smooth(method = 'lm', aes(colour = expected_change))


local2U <- lme(yi.SppR.ROM ~ Duration:expected_change + expected_change + 0, 
               random = ~ 1 | factor(Study.ID), data=event, na.action = na.omit)
summary(local2U)

#event_dir_summ_df <- 
 # mk_rma_summary_df(original_df = event, rma_object = local2, categorical = TRUE)

row.names(event_dir_summ_df) <- c(' Negative', ' Positive', ' Uncertain', 
                                  ' D*Negative', ' D*Positive', 
                                  ' D*Uncertain')

# The short term effect of events
ggplot(data = event_dir_summ_df[1:3, ]) +
  geom_point(aes(x = row.names(event_dir_summ_df[1:3, ]), y = mean_estimate)) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci, 
                    x = row.names(event_dir_summ_df[1:3, ]), width = 0)) +
  theme_bw() + 
  ylab('Change in log ratio / year\n') +
  xlab('\nEvent Type\n') + 
  theme(panel.grid.major  = element_blank(),
        panel.grid.minor  = element_blank()) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = 'yellow') +
  ylim(c(-0.75, 0.75)) +
  scale_x_discrete(labels = paste(row.names(event_dir_summ_df[1:3, ]), "\n k = ", as.character(event_dir_summ_df[1:3, ]$studies_per_mod), "\n n = ", as.character(event_dir_summ_df[1:3, ]$sites_per_mod)))

# The long term effect of events:
ggplot(data = event_dir_summ_df[4:6, ]) +
geom_point(aes(x = row.names(event_dir_summ_df[4:6, ]), y = mean_estimate)) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci, 
                    x = row.names(event_dir_summ_df[4:6, ]), width = 0)) +
  theme_bw() + 
  ylab('Change in log ratio / year\n') +
  xlab('\nEvent Type\n') + 
  theme(panel.grid.major  = element_blank(),
        panel.grid.minor  = element_blank()) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = 'yellow') +
  ylim(c(-0.1, 0.1)) +
  scale_x_discrete(labels = paste(row.names(event_dir_summ_df[4:6, ]), "\n k = ", as.character(event_dir_summ_df[4:6, ]$studies_per_mod), "\n n = ", as.character(event_dir_summ_df[4:6, ]$sites_per_mod)))


```

What sample sizes do we have for this local even dataset? The weighted analysis is done using 27 negative events, 19 positive events, and 14 uncertain events.

```{r}
filter(event, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & vi.SppR.ROM > 0) %>%
  count(., expected_change)

```

In the unweighted model there is no significant effect of event except in those studies for which an exepcted change direction was unclear. In these studies there was a decline in species in long term studies of about -1% per year. 

Clarify: -1% change in ther ate of change -> this is the duration effect alone? From log_ratio ~ Duration?

```{r}
local_lme <- 
  lme(yi.SppR.ROM ~ Duration:expected_change + expected_change + 0, 
      random = ~ 1 | factor(Study.ID), 
      data = event, na.action = na.omit)
summary(local_lme)

get_percent_change(local_lme$coefficients$fixed)
```

In the subset of studies for which no events were explicitly documented, cumulative human impacts were associated with immediate declines. On average when mean impact was zero, species declined by 4.8%. For each unit of cumulative human impact (global range = ~0 - 11.1 (need to double check this value); from our study range = 0.26 - 9.5), our results show that the rate of species loss increases by 7.5%. However, as study duration increases, the effect of mean impact on the rate of change in species richness is actually positive. Cumulative human impact moderates the rate of change in richness by 1 % per year. (Does this mean that each year the rate of change in richness is: -4.8% * 1.2)

However, the unweighted analyses do not a change in richness over time, nor an effect of cumulative impact. 

Does this conflict at all with the fact that duration * events have the opposite effect as we expected?

```{r}
global1 <- 
  rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM, 
         data = no_event,
         random = ~ 1 | Study.ID, 
         mods = ~ Duration * mean_imps)
global1

get_percent_change(global1$b)
```


```{r}
global2 <- 
  rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM, 
         data = fl_combined,
         random = ~ 1 | Study.ID, 
         mods = ~ Duration * mean_imps)
global2


global_summ_df <- 
  mk_rma_summary_df(no_event, rma_object = global1)

filter(no_event, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                     vi.SppR.ROM > 0 & !is.na(mean_imps)) %>%
  distinct(Site) %>%
  count(.)

row.names(global_summ_df) <- c('Intercept', 'Duration', 'Human Impact', 
                                'Duration*Human Impact')
global_summ_df$predictors <- factor(row.names(global_summ_df), levels = c('Intercept', 'Duration', 'Human Impact', 'Duration*Human Impact'))

# Fix graph
ggplot(data = global_summ_df) +
  geom_point(aes(x = mean_estimate, y = predictors), 
             size = 4, colour = 'white') +
  geom_errorbarh(aes(x = mean_estimate, xmin = lower_ci, xmax = upper_ci, 
                    y = predictors, height = 0), colour = 'white', 
                    size = 1) + 
  theme_wb() + 
  xlab('Mean Effect Size\n') +
  ylab('\nPredictor') + 
  theme(axis.title.x = element_text(vjust = -0.5, size = 16), 
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), 
        axis.title.y = element_text(vjust = 1.5, size = 16), 
        panel.grid.major  = element_blank(),
        panel.grid.minor  = element_blank()) +
  geom_vline(xintercept = 0, linetype = "dashed", colour = 'yellow')
  #xlim(c(-8, 8))


global_lme <- 
filter(fl_combined, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                     vi.SppR.ROM > 0 & !is.na(mean_imps)) %>%
  lme(yi.SppR.ROM ~ Duration * scale(mean_imps), random = ~ 1 | factor(Study.ID),
      data = .)
summary(global_lme)


global2 <- 
filter(no_event, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                     vi.SppR.ROM > 0 & !is.na(mean_imps)) %>%
    rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM,
          data = ., 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (mean_lin_change + mean_invs +  mean_nuts)
)
global2


global2 <- 
filter(fl_combined, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                     vi.SppR.ROM > 0 & !is.na(mean_imps)) %>%
    rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM,
          data = ., 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (mean_lin_change + mean_invs +  mean_nuts)
)
global2


global3 <- 
filter(fl_combined, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                     vi.SppR.ROM > 0 & !is.na(mean_imps)) %>%
    rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM,
          data = ., 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (mean_vocc + mean_invs +  mean_nuts)
)
global3


# Study specific slices
global4 <- 
filter(fl_combined, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                     vi.SppR.ROM > 0 & !is.na(mean_imps)) %>%
    rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM,
          data = ., 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (single_lin_change + mean_invs +  mean_nuts)
)
global4


global5 <- 
filter(fl_combined, !is.na(yi.SppR.ROM) & !is.na(vi.SppR.ROM) & 
                     vi.SppR.ROM > 0 & !is.na(mean_imps)) %>%
    rma.mv(yi = yi.SppR.ROM, V = vi.SppR.ROM,
          data = ., 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (single_vel + mean_invs +  mean_nuts)
)
global5


global_summ_df <- 
  mk_rma_summary_df(fl_combined, rma_object = global2)
```