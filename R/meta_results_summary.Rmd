## Local marine diversity change meta-analysis model results

```{r, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message = FALSE)
```

```{r, include=FALSE}

library(raster)
library(dplyr)
library(ggplot2)
library(metafor)
library(lme4)
library(lmerTest)
library(gridExtra)
library(broom)
library(knitr)

source('02_functions.R')

fl_combined <- readr::read_csv("../Data_outputs/fl_combined.csv") %>% 
  mutate(Study.ID = factor(Study.ID))

#fl_combined <- mutate(fl_combined, mean_invs = replace(mean_invs, is.na(mean_invs) & mean_nuts >= 0, 0))

event <- filter(fl_combined, Event == 'Yes')
no_event <- filter(fl_combined, Event != 'Yes')

```

### Duration analysis

To test whether local marine species richness has changed over time, we performed a meta-regression on the relationship between the log ratio of species richness between the final and initial time points and study duration. The weighted analysis included 213 sites and 50 studies while the unweighted analysis included 505 sites and 122 studies.  

In the both the variance-weighted meta-regression, **species richness did not change over time on average**.

```{r, echo=FALSE, include=FALSE}
# Weighted analysis - and naive model plot
mod1 <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = filter(fl_combined, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & 
                       vi_SppR_ROM > 0),
         random = ~ 1 | as.factor(Study.ID), 
         mods = ~ Duration)
mod1

# Unweighted analysis that includes all of the log ratios that do not have 
# variance associated with them. 
lme1 <- lmer(yi_SppR_ROM ~ Duration + (1 | Study.ID), 
            data = no_event, na.action = na.omit)
summary(lme1)

```

```{r, echo=FALSE, fig.height=6, fig.width=8.5, fig.cap='**Figure 1.** Variance-weighted meta-regression (left) and unweighted linear mixed effects model (right) show no change in the log ratio of species richness over time. Both analyses treated individual studies as random effects.'}
duration_w <- 
filter(no_event, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & vi_SppR_ROM > 0) %>%
ggplot(data = ., aes(x = Duration, y = yi_SppR_ROM, colour = as.factor(Study.ID))) +
  geom_point(size = 1) + 
  ylab('Log Ratio') +
  theme_bw() +
  theme(legend.position = 'none') +
  geom_hline(yintercept = 0, colour = 'red', linetype = 'dashed') +
  ggtitle('Weighted Analysis') + 
  xlab('Duration (years)') +
  ylim(-2, 2)

duration_uw <- 
filter(no_event, !is.na(yi_SppR_ROM)) %>%
ggplot(data = ., aes(x = Duration, y = yi_SppR_ROM, colour = as.factor(Study.ID))) +
  geom_point(size = 1) + 
  ylab('Log Ratio') +
  theme_bw() +
  theme(legend.position = 'none') +
  geom_hline(yintercept = 0, colour = 'red', linetype = 'dashed') +
  ggtitle('Unweighted Analysis') + 
  xlab('Duration (years)') +
  ylim(-3, 3)

grid.arrange(duration_w, duration_uw, ncol = 2)
```

### Cumulative human impacts model 

```{r, include=FALSE}

impact_ne_w <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = no_event,
         random = ~ 1 | factor(Study.ID), 
         mods = ~ Duration * mean_imps)
impact_ne_w

impact_lme_ne <- 
  lmer(yi_SppR_ROM ~ Duration * mean_imps + (1 | Study.ID),
      data = no_event, na.action = na.omit)
summary(impact_lme_ne)

```

In the short term, cumulative impacts were associated with an average loss of species of 5% for each increase in unit of cumulative human impact. Globally these impact values range from 0 to >15. When cumulative human impacts were included in the analysis, an average effect of duration was observed, with a decline on average of -3.5 % of species per year in the absence of cumulative human impacts. However, when the effect of cumulative human impacts are considered over time, they are associated with an increase in species richness, of 0.92 % / (year * impact score) (Figs 2, 3). 


The fifty percent of our studies have cumulative human impact values between 2.84 and 5.03. This analysis highlights how biases in the way that we have sampled local communities can obscure effects of human impacts on local scale species richness change. If this sampling is representative of studies used in previous analyses, they do not represent the spread of human impacts affecting marine communities. 

This long term perspective may 

```{r, echo=FALSE}

data_frame(parameter = rownames(impact_ne_w$b), 
           `VW % change`  = round(as.vector(get_percent_change(impact_ne_w$b)), digits = 4), 
           `VW p-value`  = round(impact_ne_w$pval, digits = 4), 
           `UW % change`  = round(as.vector(get_percent_change(summary(impact_lme_ne)$coefficients[, 1])), digits = 4), 
           `UW p-value`  = round(summary(impact_lme_ne)$coefficients[, 5], digits = 4)
           ) %>%
knitr::kable(., digits = 3, caption = '**Table 1.** Variance-weighted (VW) and unweighted (UW) meta-regression of the proportion of species richness change across a gradient of human impacts over time including the estimated percent change per unit of the driver and the corresponding model p-value. The percent change has been back-calculated from the estimated log ratio of the proportion of change in species richness.')

```

```{r, echo=FALSE, fig.cap='**Figure 2.** Coefficient estimates for the relationship of the log-proportion of change in species richness over time, as moderated by cumulative human impacts (Halpern et al 2015). Points represent coefficient estimates and lines represent 95% CI obtained using a variance-weighted meta-regression.'}

mk_rma_summary_df(impact_ne_w) %>%
  mutate(driver = gsub("mean_imps", "Human Impact", driver)) %>%
  filter(driver != 'intrcpt') %>% 
  mutate(driver = factor(driver, levels = c('Duration:Human Impact', 'Duration', 'Human Impact'))) %>%
  ggplot(data = ., aes(x = estimate, y = driver)) + 
    theme_bw() +
    geom_errorbarh(aes(xmin = ci_lb, xmax = ci_ub), height = 0, size = 1.5) + 
    geom_point(size = 4) + 
    geom_vline(xintercept = 0, colour = 'black', linetype = 'dashed') + 
    xlim(c(-0.12, 0.12)) + 
    theme(axis.text.y = element_text(hjust = 1, size = 14), 
          axis.text.x = element_text(size = 14), 
          axis.title = element_text(size = 16)) + 
    ylab("") + 
    xlab('\nCoefficient estimate')

```

```{r, include=FALSE}
# Get range of durations used in impact_ne_w:
no_event %>% 
  filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_imps)) %>% 
  .$Duration %>% 
  range(.)

# Get minimum impact value used in impact_ne_w:
no_event %>% 
  filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_imps)) %>% 
  summarise(min = min(mean_imps), 
            median = median(mean_imps), 
            mean = mean(mean_imps), 
            max = max(mean_imps), 
            duration = max(Duration))

# Get minimum impact value used in impact_ne_w:
no_event %>% 
  filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_imps)) %>% 
  .$mean_imps %>% 
  quantile(.)

q0_imps <- get_imp_predictions(rma_object = impact_ne_w, impact_value = 0.89, duration = 41)
q25_imps <- get_imp_predictions(rma_object = impact_ne_w, impact_value = 2.84, duration = 41)
q50_imps <- get_imp_predictions(rma_object = impact_ne_w, impact_value = 3.58, duration = 41)
q75_imps <- get_imp_predictions(rma_object = impact_ne_w, impact_value = 5.04, duration = 41)
q100_imps <- get_imp_predictions(rma_object = impact_ne_w, impact_value = 8.95, duration = 41)

impact_predicted_log_ratio <- 
  ggplot() + 
    geom_line(data = q0_imps, aes(x = 1:41, y = pred), colour = 'blue') + 
    geom_text(data = q0_imps[41, ], label = '0.89', aes(x = 44, y = pred, vjust = 0.25), colour = 'blue') +
    geom_ribbon(data = q0_imps, aes(x = 1:41, ymin = ci.lb, ymax = ci.ub), fill = 'light blue', alpha = 0.4) + 
    geom_line(data = q25_imps, aes(x = 1:41, y = pred), colour = 'green') + 
    geom_text(data = q25_imps[41, ], label = '2.84', aes(x = 44, y = pred, vjust = 0.25), colour = 'green') +
    geom_ribbon(data = q25_imps, aes(x = 1:41, ymin = ci.lb, ymax = ci.ub), fill = 'light green', alpha = 0.4) + 
    geom_line(data = q50_imps, aes(x = 1:41, y = pred), colour = 'yellow') + 
    geom_text(data = q50_imps[41, ], label = '3.58', aes(x = 44, y = pred, vjust = 0.25), colour = 'gold') +
    geom_ribbon(data = q50_imps, aes(x = 1:41, ymin = ci.lb, ymax = ci.ub), fill = 'light goldenrod', alpha = 0.4) + 
    geom_line(data = q75_imps, aes(x = 1:41, y = pred), colour = 'orange') + 
    geom_text(data = q75_imps[41, ], label = '5.04', aes(x = 44, y = pred, vjust = 0.25), colour = 'orange') +
    geom_ribbon(data = q75_imps, aes(x = 1:41, ymin = ci.lb, ymax = ci.ub), fill = 'moccasin', alpha = 0.4) + 
    geom_line(data = q100_imps, aes(x = 1:41, y = pred), colour = 'red') + 
    geom_text(data = q100_imps[41, ], label = '8.95', aes(x = 44, y = pred, vjust = 0.25), colour = 'red') +
    geom_ribbon(data = q100_imps, aes(x = 1:41, ymin = ci.lb, ymax = ci.ub), fill = 'light coral', alpha = 0.4) + 
    theme_minimal() + 
    ylab('Predicted proportion of change') + 
    xlab('Duration (years)')

observed_log_ratio <- 
  no_event %>% 
    filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_imps)) %>% 
    ggplot(data = .) + 
      geom_point(aes(x = Duration, y = yi_SppR_ROM, colour = Study.ID)) + 
      theme_minimal() + 
      theme(legend.position = 'none') + 
      geom_hline(yintercept = 0, colour = 'black', size = 0.15) + 
      geom_vline(xintercept = 0, colour = 'black', size = 0.15) + 
      ylab('Percent change') + 
      xlab('Duration (years)')

impact_predicted_percent_change <- 
  ggplot() + 
    geom_line(data = q0_imps, aes(x = 1:41, y = get_percent_change(pred)), colour = 'blue') + 
    geom_text(data = q0_imps[41, ], label = '0.89', aes(x = 44, y = get_percent_change(pred), vjust = 0.25), colour = 'blue') +
    geom_ribbon(data = q0_imps, aes(x = 1:41, ymin = get_percent_change(ci.lb), ymax = get_percent_change(ci.ub)), fill = 'light blue', alpha = 0.4) + 
    geom_line(data = q25_imps, aes(x = 1:41, y = get_percent_change(pred)), colour = 'green') + 
    geom_text(data = q25_imps[41, ], label = '2.84', aes(x = 44, y = get_percent_change(pred), vjust = 0.25), colour = 'green') +
    geom_ribbon(data = q25_imps, aes(x = 1:41, ymin = get_percent_change(ci.lb), ymax = get_percent_change(ci.ub)), fill = 'light green', alpha = 0.4) + 
    geom_line(data = q50_imps, aes(x = 1:41, y = get_percent_change(pred)), colour = 'yellow') + 
    geom_text(data = q50_imps[41, ], label = '3.58', aes(x = 44, y = get_percent_change(pred), vjust = 0.25), colour = 'gold') +
    geom_ribbon(data = q50_imps, aes(x = 1:41, ymin = get_percent_change(ci.lb), ymax = get_percent_change(ci.ub)), fill = 'light goldenrod', alpha = 0.4) + 
    geom_line(data = q75_imps, aes(x = 1:41, y = get_percent_change(pred)), colour = 'orange') + 
    geom_text(data = q75_imps[41, ], label = '5.04', aes(x = 44, y = get_percent_change(pred), vjust = 0.25), colour = 'orange') +
    geom_ribbon(data = q75_imps, aes(x = 1:41, ymin = get_percent_change(ci.lb), ymax = get_percent_change(ci.ub)), fill = 'moccasin', alpha = 0.4) + 
    geom_line(data = q100_imps, aes(x = 1:41, y = get_percent_change(pred)), colour = 'red') + 
    geom_text(data = q100_imps[41, ], label = '8.95', aes(x = 44, y = get_percent_change(pred), vjust = 0.25), colour = 'red') +
    geom_ribbon(data = q100_imps, aes(x = 1:41, ymin = get_percent_change(ci.lb), ymax = get_percent_change(ci.ub)), fill = 'light coral', alpha = 0.4) + 
    theme_minimal() + 
    theme_minimal() + 
    ylab('Predicted percent change\n') + 
    xlab('\nDuration (years)') + 
    geom_hline(yintercept = 0, colour = 'black', size = 0.15) + 
    geom_vline(xintercept = 0, colour = 'black', size = 0.15) + 
    scale_x_continuous(breaks = seq(from = 0, to = 41, by = 5))

observed_percent_change <- 
  no_event %>% 
    filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_imps)) %>% 
    ggplot(data = .) + 
      geom_point(aes(x = Duration, y = get_percent_change(yi_SppR_ROM), colour = Study.ID)) + 
      theme_minimal() + 
      theme(legend.position = 'none') + 
      geom_hline(yintercept = 0, colour = 'black', size = 0.15) + 
      geom_vline(xintercept = 0, colour = 'black', size = 0.15) + 
      ylab('Percent change') + 
      xlab('Duration (years)') + 
      scale_x_continuous(breaks = seq(from = 0, to = 41, by = 5))

```

```{r, echo=FALSE, fig.height=6, fig.width=8.5, fig.cap='**Figure 3.** Observed log response ratios of proportion of species richness change over 41 years (left) and predicted log response ratios of species richness change over 41 years (right) as moderated by five quantiles of cumulative human impacts observed in our dataset: q0 = 0.89 (blue), q25 = 2.84 (green), q50 = 3.58 (yellow), q75 = 5.04 (orange), q100 = 8.95 (red).'}

grid.arrange(observed_log_ratio, impact_predicted_log_ratio, ncol = 2)

```

```{r, echo=FALSE, fig.height=6, fig.width=8.5, fig.cap='**Figure 4.** Observed percent change in species richness over 41 years (left) and predicted percent change of species richness change over 41 years (right) as moderated by five quantiles of cumulative human impacts observed in our dataset: q0 = 0.89 (blue), q25 = 2.84 (green), q50 = 3.58 (yellow), q75 = 5.04 (orange), q100 = 8.95 (red)'}

grid.arrange(observed_percent_change, impact_predicted_percent_change, ncol = 2)

```

```{r, echo=FALSE, fig.cap='**Figure 5.** Frequency distribution of cumulative human impacts across the data used for the variance-weighted meta-regression'}

ggplot(data = no_event %>% filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_imps)), 
       aes(x = mean_imps)) + 
  geom_histogram(binwidth = 1, colour = 'black', boundary = 0) + 
  scale_x_continuous(breaks = 0:10) + 
  theme_minimal() + 
  xlab('\nCumulative human impact score') + 
  ylab('Frequency\n')

```

### Specific drivers model 

The cumulative human impact values provide evidence that species richness changes are context dependent and suggest that sampling bias may help explain why recent synthese have observed no average change in local species richness (Vellend et al 2014, Dornelas et al 2015), the impact scores summarise 17(?) different human impacts in marine ecosystems. We ask whether direction and magnitude of local species richness change can be attributed more specifically to three primary global drivers. Temperature change, nutrient addition, and invasive species are three important drivers that are associated with changes in local communities (Murphy and Romanuk 2014?). 

```{r, include=FALSE}

# Check for collinearity among the 4 proposed drivers. Collinearity was low for 
# all variables except the decadal rate of linear temperature change and 
# climate velocity (covariance = 0.87). Therefore only linear temperature change 
# was used in the following analyses. 
cov(no_event %>% 
    filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_invs) & 
           !is.na(mean_nuts) & !is.na(sliced_vocc) & !is.na(sliced_ltc)) %>% 
    mutate(scaled_invs = scale(mean_invs * 10^-3), 
           scaled_nuts = scale(mean_nuts), 
           scaled_vocc = scale(sliced_vocc), 
           scaled_ltc  = scale(sliced_ltc)) %>% 
    select(scaled_invs, scaled_nuts, scaled_vocc, scaled_ltc)
)

# No interactions
drivers <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = no_event %>% mutate(scaled_invs = mean_invs * 10^-3), 
         random = ~ 1 | Study.ID, 
         mods = ~ Duration * (scale(scaled_invs) + scale(sliced_ltc) + scale(mean_nuts)))
drivers

drivers_unscaled <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = no_event %>% mutate(scaled_invs = mean_invs * 10^-3), 
         random = ~ 1 | Study.ID, 
         mods = ~ Duration * (scaled_invs + sliced_ltc + mean_nuts))
drivers_unscaled


drivers_uw <- 
  lmer(yi_SppR_ROM ~ Duration * (scale(scaled_invs) + scale(sliced_vocc) + scale(mean_nuts)) + (1 | Study.ID), 
       data = no_event %>% mutate(scaled_invs = mean_invs * 10^-3), 
       na.action = na.omit)
summary(drivers_uw)

```

Once additional and specific drivers of global change are included in the analysis, there is a signal of species gains over time at a rate of 1.7% of species per year (Duration, p-value = 0.012; *Not sure what to make of this duration estimate being positive but the one from the cumulative human impacts is negative -- is this essentially 'leftover' change that is not accounted for by the specific drivers?*).  Over the short term, propagule pressure (invasives) was associated with declines in local species richness at a rate of -1.8% of species per 1000(*?*) units of increased propagule pressure, wherease nutrient addition was associated with species gains observed over the short term at a rate of 1.4% per unit of nutrient addition (p = 0.002, *this percentage seems too large*). Linear temperature change was a marginally significant predictor (p-value = 0.056) of species richness change in the short term and was also associated with species gains. 

However, over the long term, these drivers show a reversed direction of effect on the rate of local species richness change. Studies that were longer in duration showed gains with increasing propgule pressure, but losses with higher rates of nutrient addition and linear temperature change. 


```{r, echo=FALSE}

data_frame(parameter = rownames(drivers_unscaled$b), 
           `VW % change`  = round(as.vector(get_percent_change(drivers_unscaled$b)), digits = 4), 
           `VW p-value`  = round(drivers_unscaled$pval, digits = 4), 
           `UW % change`  = round(as.vector(get_percent_change(summary(drivers_uw)$coefficients[, 1])), digits = 4), 
           `UW p-value`  = round(summary(drivers_uw)$coefficients[, 5], digits = 4)
           ) %>%
knitr::kable(., digits = 3, caption = '**Table 2.** Variance-weighted (VW) and unweighted (UW) meta-regression of the proportion of species richness change across a gradient of three drivers (raw coefficient estimates, except for invasives --> invs * 0.001) of global change over time including the estimated percent change per unit of the driver and the corresponding model p-value. The percent change has been back-calculated from the estimated log ratio of the proportion of change in species richness.')

```

```{r, include=FALSE}

model_driver_vector <- 
  c('Duration', 'Invasives', 'LTC', 'Nutrients', 'Duration*Invasives', 
    'Duration*LTC', 'Duration*Nutrients')
ordered_driver_vector <- 
  c('Duration', 'Invasives', 'Nutrients', 'LTC', 'Duration*Invasives', 
    'Duration*Nutrients', 'Duration*LTC')

driver_summary_plot  <- 
  mk_rma_summary_df(drivers) %>% 
    filter(driver != 'intrcpt') %>% 
    mutate(grouping = as.character(driver)) %>% 
    mutate(grouping = factor(model_driver_vector, 
                             levels = rev(ordered_driver_vector))) %>% 
    ggplot(data = ., aes(x = estimate, y = grouping)) + 
      theme_bw() +
      geom_errorbarh(aes(xmin = ci_lb, xmax = ci_ub), height = 0, size = 1.5) + 
      geom_point(size = 4) + 
      geom_vline(xintercept = 0, colour = 'black', linetype = 'dashed') + 
      xlim(c(-3.5, 3.5)) + 
      theme(axis.text.y = element_text(hjust = 1, size = 14), 
            axis.text.x = element_text(size = 14), 
            axis.title = element_text(size = 16)) + 
      ylab("") + 
      xlab('\nStandardised coefficient estimate')

```

```{r, echo=FALSE, fig.height=6, fig.width=8.5, fig.cap='**Figure 6.** The relationship of the log-proportion of change in species richness over time, as moderated by three drivers of global change, invasives (propagule pressure), nutrient addition, and LTC (the decadal rate of linear temperature change). Points represent standardised coefficient estimates and lines represent 95% CI obtained using a variance-weighted meta-regression.'}

driver_summary_plot
```




#### Specific drivers and their interactions

Interactions between changing temperature and invasive species colonisation and changing temperature and nutrient addition have been predicted theoretically and are supported by observational (Sorte et al 2010 (invs), REFS) and experimental data (Binzer et al 2012 (nuts), REFS). We tested whether the effects of these interactions between temperature, propagule pressure, and nutrient addition were observed in our data. We did not observe an effect of these interactions in our data, however, this may be due to low power caused by the high parameterisation of the model. 

```{r, include=FALSE}

# Invasives * temperature (Sorte et al 2010, )
# Nutrients * temperature (Binzer et al 2012)
interactions <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = no_event %>% mutate(scaled_invs = mean_invs * 10^-3), 
         random = ~ 1 | Study.ID, 
         mods = ~ Duration * (scale(scaled_invs) * scale(sliced_ltc) + scale(sliced_ltc)*scale(mean_nuts)))

interactions_uw <- 
  lmer(yi_SppR_ROM ~ Duration * (scale(scaled_invs) * scale(sliced_ltc) + 
         scale(sliced_ltc)*scale(mean_nuts)) + (1 | Study.ID), 
       data = no_event %>% mutate(scaled_invs = mean_invs * 10^-3), 
       na.action = na.omit)
summary(interactions_uw)

```

```{r, echo=FALSE}

data_frame(parameter = rownames(interactions$b), 
           `VW % change` = round(as.vector(get_percent_change(interactions$b)), digits = 4), 
           `VW p-value` = round(interactions$pval, digits = 4), 
           `UW % change` = round(as.vector(get_percent_change(summary(interactions_uw)$coefficients[, 1])), digits = 4), 
           `UW p-value` = round(summary(interactions_uw)$coefficients[, 5], digits = 4)
           ) %>%
knitr::kable(., digits = 3, caption = '**Table 3. - text incomplete** Variance-weighted (VW) and unweighted (UW) meta-regression of the proportion of species richness change where model includes interactions \nincluding the estimated percent change per unit of the driver and the corresponding model p-value. The percent change has been back-calculated from the estimated log ratio of the proportion of change in species richness.')


```


--------------------------------------------------------------------------------
*Help - predictions of drivers model*

```{r, include=FALSE}

# Use LR ~ Duration * (scaled_invs + sliced_ltc + mean_nuts) model fitted to 
# data to make predictions for the effects of three different drivers on 
# species richness change over a given duration.
#
get_driver_predictions <- function(unscaled_rma_object, invs, nuts, temp, duration) {
#browser()
  # invasive values were scaled by 0.001 to make invasives data variance similar
  # in magnitude to the other drivers 
  invs <- invs * 10^-3
#
  mods = cbind(1:duration, rep(invs, duration), rep(nuts, duration), 
               rep(temp, duration), invs*(1:duration), nuts*(1:duration), 
               temp*(1:duration))
  predictions <- predict(object = unscaled_rma_object, newmods = mods)
  class(predictions) <- 'list'
  predictions <- predictions[1:6]
  predictions <- as_data_frame(predictions)
  return(predictions)
}

# Get range of durations used in impact_ne_w:
no_event %>% 
  filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_invs) & 
         !is.na(mean_nuts) & !is.na(sliced_ltc)) %>% 
  .$Duration %>% 
  range(.)

# Get minimum impact value used in impact_ne_w:
invs_quantiles <- 
  no_event %>% 
    filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_invs) & 
           !is.na(mean_nuts) & !is.na(sliced_ltc)) %>% 
    .$mean_invs %>% 
    quantile(.) %>% 
    as.list(.) %>% 
    as_data_frame(.)

nut_quantiles <- 
  no_event %>% 
    filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_invs) & 
           !is.na(mean_nuts) & !is.na(sliced_ltc)) %>% 
    .$mean_nuts %>% 
    quantile(.) %>% 
    as.list(.) %>% 
    as_data_frame(.)

ltc_quantiles <- 
  no_event %>% 
    filter(!is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(mean_invs) & 
           !is.na(mean_nuts) & !is.na(sliced_ltc)) %>% 
    .$sliced_ltc %>% 
    quantile(.) %>% 
    as.list(.) %>% 
    as_data_frame(.)

invs_q0  <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = invs_quantiles$`0%`, 
                                   nuts = 0, temp = 0, duration = 41) %>% 
            mutate(driver = 'invasives', quantile = '0', 
                   value = invs_quantiles$`0%`)
invs_q25 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = invs_quantiles$`25%`, 
                                   nuts = 0, temp = 0, duration = 41) %>% 
            mutate(driver = 'invasives', quantile = '25', 
                   value = invs_quantiles$`25%`)
invs_q50 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = invs_quantiles$`50%`, 
                                   nuts = 0, temp = 0, duration = 41) %>% 
            mutate(driver = 'invasives', quantile = '50', 
                   value = invs_quantiles$`50%`)
invs_q75 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = invs_quantiles$`75%`,
                                   nuts = 0, temp = 0, duration = 41) %>% 
            mutate(driver = 'invasives', quantile = '75', 
                   value = invs_quantiles$`75%`)
invs_q100 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = invs_quantiles$`100%`, 
                                   nuts = 0, temp = 0, duration = 41) %>% 
            mutate(driver = 'invasives', quantile = '100', 
                   value = invs_quantiles$`100%`)
invs_predictions <- 
  rbind_all(list(invs_q0, invs_q25, invs_q50, invs_q75, invs_q100))

nuts_q0  <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = nutrient_quantiles$`0%`, 
                                   temp = 0, duration = 41) %>% 
            mutate(driver = 'nutrients', quantile = '0', 
                   value = nut_quantiles$`0%`)
nuts_q25 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = nut_quantiles$`25%`, 
                                   temp = 0, duration = 41) %>% 
            mutate(driver = 'nutrients', quantile = '25', 
                   value = nut_quantiles$`25%`)
nuts_q50 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = nut_quantiles$`50%`, 
                                   temp = 0, duration = 41) %>% 
            mutate(driver = 'nutrients', quantile = '50', 
                   value = nut_quantiles$`50%`)
nuts_q75 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = nut_quantiles$`75%`, 
                                   temp = 0, duration = 41) %>% 
            mutate(driver = 'nutrients', quantile = '75', 
                   value = nut_quantiles$`75%`)
nuts_q100 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = nut_quantiles$`100%`, 
                                   temp = 0, duration = 41) %>% 
            mutate(driver = 'nutrients', quantile = '100', 
                   value = nut_quantiles$`100%`)
nuts_predictions <- 
  rbind_all(list(nuts_q0, nuts_q25, nuts_q50, nuts_q75, nuts_q100))

ltc_q0  <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = 0, 
                                   temp = ltc_quantiles$`0%`, duration = 41) %>%
            mutate(driver = 'ltc', quantile = '0', value = ltc_quantiles$`0%`)
ltc_q25 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = 0, 
                                   temp = ltc_quantiles$`25%`, duration = 41) %>%
            mutate(driver = 'ltc', quantile = '25', value = ltc_quantiles$`25%`)
ltc_q50 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = 0, 
                                   temp = ltc_quantiles$`50%`, duration = 41) %>%
            mutate(driver = 'ltc', quantile = '50', value = ltc_quantiles$`50%`)
ltc_q75 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = 0, 
                                   temp = ltc_quantiles$`75%`, duration = 41) %>%
            mutate(driver = 'ltc', quantile = '75', value = ltc_quantiles$`75%`)
ltc_q100 <- get_driver_predictions(unscaled_rma_object = drivers_unscaled, 
                                   invs = 0, nuts = 0, 
                                   temp = ltc_quantiles$`100%`, duration = 41) %>%
            mutate(driver = 'ltc', quantile = '100', value = ltc_quantiles$`100%`)
ltc_predictions <- 
  rbind_all(list(ltc_q0, ltc_q25, ltc_q50, ltc_q75, ltc_q100))


ggplot(data = filter(invs_predictions, quantile == '100'), aes(x = 1:41, y = pred, by = quantile)) + 
 geom_line() + 
 geom_ribbon(aes(x = 1:41, ymin = ci.lb, ymax = ci.ub), alpha = 0.4)


```




Next steps of output:

* predicted distribution of local species richness change based on 