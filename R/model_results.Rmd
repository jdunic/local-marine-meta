```{r, echo = FALSE, warning=FALSE, message=FALSE}

library(raster)
library(dplyr)
library(ggplot2)
library(metafor)
library(lme4)
library(lmerTest)
library(gridExtra)
library(broom)
library(knitr)
library(pander)

pander::panderOptions('table.split.table', 100)
options(width = 100)

source('R/02_functions.R')

fl_combined <- readr::read_csv("Data_outputs/fl_combined.csv") %>% 
  mutate(Study.ID = factor(Study.ID))

#fl_combined <- mutate(fl_combined, mean_invs = replace(mean_invs, is.na(mean_invs) & mean_nuts >= 0, 0))

event <- filter(fl_combined, Event == 'Yes')
no_event <- filter(fl_combined, Event != 'Yes')

```

The log ratio is the natural logarithm of the proportion of change in species richness (ln(final richness / initial richness)). We calculate the percent change in species richness as exp(log ratio) = final richness / initial richness. 

```{r, echo = FALSE, eval = FALSE}
# Log ratio reference for me
# When there is no change in richness, final / initial = 1
log(1) = 0

# Example: 50% increase in richness between time points
# When richness increases over time, final / initial > 1
log(150 / 100)
0.4054651
# Percent change = exp(log ratio) - 1
exp(0.4054651) - 1

# Example: 50% decrease in richness between time points
# When richness decreases over time, final / initial < 1
log(50 / 100)
[1] -0.6931472
# Percent change = exp(log ratio) - 1
exp(-0.6931472) - 1
```

To test whether local marine species richness has changed over time, we have performed a meta-regression on the relationship between the log ratio of species richness between the final and initial time points and study duration. The weighted analysis included 213 sites and 50 studies while the unweighted analysis included 505 sites and 122 studies.  

In the both the weighted and unweighted analyses, species richness did not change on average (mod1, mod2), nor was there a relationship between change in species richness and duration (mod1).

```{r}

# Weighted analysis - and naive model plot
mod1 <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = filter(fl_combined, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & 
                       vi_SppR_ROM > 0),
         random = ~ 1 | as.factor(Study.ID), 
         mods = ~ Duration)
mod1

mod2 <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = filter(fl_combined, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & 
                       vi_SppR_ROM > 0),
          random = ~ 1 | as.factor(Study.ID), 
          mods = ~Duration)
mod2

# Unweighted analysis that includes all of the log ratios that do not have 
# variance associated with them. 
lme1 <- lme(yi_SppR_ROM ~ Duration, random = ~ 1 | factor(Study.ID), 
            data = fl_combined, na.action = na.omit)
summary(lme1)
```

Looking at the caterpillar plot for each of the studies, it is probably best to keep Study.ID as a random effect.

```{r, echo = FALSE, eval = FALSE}
rr <- ranef(lme1)
rr.order <- rr[order(rr$`(Intercept)`), , drop = FALSE]
rr.order$Study.ID <- factor(row.names(rr.order), levels = row.names(rr.order))

ggplot(data = rr.order, aes(x = Study.ID, y = `(Intercept)`)) + 
  geom_point() + 
  geom_hline(yintercept = 0, colour = 'red', linetype = 'dashed') + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 5))

```

```{r, fig.height=7.5, fig.width=6.7}
duration_w <- 
filter(fl_combined, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & vi_SppR_ROM > 0) %>%
ggplot(data = ., aes(x = Duration, y = yi_SppR_ROM, colour = as.factor(Study.ID))) +
  geom_point(size = 1) + 
  ylab('Log Ratio') +
  theme_bw() +
  theme(legend.position = 'none') +
  geom_hline(yintercept = 0, colour = 'red', linetype = 'dashed') +
  ggtitle('Weighted Analysis') + 
  xlab('Duration (years)') #+
  #ylim(-2, 2)

duration_uw <- 
filter(fl_combined, !is.na(yi_SppR_ROM)) %>%
ggplot(data = ., aes(x = Duration, y = yi_SppR_ROM, colour = as.factor(Study.ID))) +
  geom_point(size = 1) + 
  ylab('Log Ratio') +
  theme_bw() +
  theme(legend.position = 'none') +
  geom_hline(yintercept = 0, colour = 'red', linetype = 'dashed') +
  ggtitle('Unweighted Analysis') + 
  xlab('Duration (years)') #+
  #ylim(-3, 3)

grid.arrange(duration_w, duration_uw, nrow = 2)
```

Both the weighted and unweighted naive models, where duration is the only predictor, show no significant change in species richness on average.  

In the subset of studies for which no events were explicitly documented, cumulative human impacts were associated with immediate declines. On average when mean impact was zero, species declined by 4.8%. For each unit of cumulative human impact (global range = ~0 - 11.1 (need to double check this value); from our study range = 0.26 - 9.5), our results show that the rate of species loss increases by 7.5%. However, as study duration increases, the effect of mean impact on the rate of change in species richness is actually positive. Cumulative human impact moderates the rate of change in richness by 1 % per year. (Does this mean that each year the rate of change in richness is: -4.8% * 1.2)


### Cumulative human impacts model 


#### Comparison between the cumulative impact model with no event and full datasets for weighted and unweighted analyses

In the unweighted analysis of both the event and no event data, short term studies show a positive effect of duration and cumulative human impacts. However, in the long term (duration*cumulative impact) shows a decline in richness over time. This is consistent with the weighted analysis that uses the full dataset. 


```{r}

impact_ne_w <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = no_event,
         random = ~ 1 | factor(Study.ID), 
         mods = ~ Duration * mean_imps)
impact_ne_w

impact_all_w <- 
  rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
         data = fl_combined,
         random = ~ 1 | factor(Study.ID), 
         mods = ~ Duration * mean_imps)
impact_all_w

impact_lme_ne <- 
  lmer(yi_SppR_ROM ~ Duration * mean_imps + (1 | Study.ID),
      data = no_event, na.action = na.omit)
summary(impact_lme_ne)

impact_lme_all <- 
  lmer(yi_SppR_ROM ~ Duration * mean_imps + (1 | Study.ID),
      data = fl_combined, na.action = na.omit)
summary(impact_lme_all)

data_frame(parameter = rownames(impact_ne_w$b), 
           ne_rma_change  = round(as.vector(get_percent_change(impact_ne_w$b)), digits = 4), 
           ne_rma_pval  = round(impact_ne_w$pval, digits = 4), 
           all_rma_change = round(as.vector(get_percent_change(impact_all_w$b)), digits = 4), 
           all_rma_pval = round(impact_all_w$pval, digits = 4)
           ) %>%
pandoc.table(.)

data_frame(parameter = rownames(summary(impact_lme_ne)$coefficients), 
           lme_ne_change  = round(as.vector(get_percent_change(summary(impact_lme_ne)$coefficients[, 1])), digits = 4), 
           lme_ne_pval  = round(summary(impact_lme_ne)$coefficients[, 5], digits = 4), 
           lme_all_per_change = round(as.vector(get_percent_change(summary(impact_lme_all)$coefficients[, 1])), digits = 4), 
           lme_all_pval = round(summary(impact_lme_all)$coefficients[, 5], digits = 4)
) %>%
pandoc.table(.)
```

#### Checking assumptions of the impact data model

```{r}
filter(no_event, !na.omit(Duration) & !na.omit(mean_imps)) %>%
  select(Duration, mean_imps) %>% cov(.)

#options(na.action = "na.pass")
plot(fitted(impact_ne_w), rstandard(impact_ne_w)$z, pch=19)



```


### Specific driver model selection (study specific time slices)

Duration*(I + VOCC - LTC - Nut)  
Duration*(I + V + I*L + LTC - N +I*N + L*N + VOCC)  
(with both vocc and ltc, with just vocc, and with just ltc)  
- Use AIC for model selection

```{r}
#Interaction model
rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM, 
       data = no_event %>% mutate(scaled_invs = mean_invs * 10^-3), 
       random = ~ 1 | Study.ID, 
       mods = ~ Duration * (scale(scaled_invs) * scale(sliced_ltc) + scale(sliced_ltc)*scale(mean_nuts))


# Invasives * temperature (Sorte et al 2010, )
# Nutrients * temperature (Binzer et al 2012)
```


#### Weighted analyses using the no event data

```{r}
# Simplest model with all drivers
global_ne_all_drivers <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = no_event %>% mutate(scaled_invs = (mean_invs * 10^-3)), 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (scale(scaled_invs) + scale(sliced_vocc) + scale(sliced_ltc) + scale(mean_nuts))
)
global_ne_all_drivers

global_ne_no_vocc <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = no_event %>% mutate(scaled_invs = (mean_invs * 10^-3)), 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (scaled_invs + sliced_ltc + mean_nuts)
)
global_ne_no_vocc

global_ne_no_ltc <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = no_event %>% mutate(scaled_invs = (mean_invs * 10^-3)), 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (scaled_invs + sliced_vocc + mean_nuts)
)
global_ne_no_ltc


data_frame(parameter = rownames(global_ne_all_drivers$b), 
           all_drivers_percent  = round(as.vector(get_percent_change(global_ne_all_drivers$b)), digits = 4), 
           all_drivers_pval  = round(global_ne_all_drivers$pval, digits = 4)
           ) %>% 
  left_join(., data_frame(parameter = rownames(global_ne_no_vocc$b), 
                         no_vocc_percent = round(as.vector(get_percent_change(global_ne_no_vocc$b)), digits = 4), 
                         no_vocc_pval = round(global_ne_no_vocc$pval, digits = 4))) %>%
  left_join(., data_frame(parameter = rownames(global_ne_no_ltc$b), 
                         no_ltc_percent = round(as.vector(get_percent_change(global_ne_no_ltc$b)), digits = 4), 
                         no_ltc_pval = round(global_ne_no_ltc$pval, digits = 4))) %>%
pandoc.table(.)

```

#### Weighted analyses using the full dataset

```{r}
# Check covariance matrix - reveals that vocc and ltc are colinear (0.8)
cor(dplyr::select(fl_combined, mean_invs, sliced_vocc, sliced_ltc, mean_nuts), use = 'complete.obs')

filter(fl_combined, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(SppR1) & !is.na(mean_invs) & !is.na(sliced_ltc) & !is.na(mean_nuts)) %>% mutate(scaled_invs = (mean_invs * 10^-3)) %>% select(Duration, SppR1, scaled_invs, mean_nuts, sliced_ltc) %>% cov(., use = 'complete.obs')

filter(fl_combined, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & !is.na(SppR1) & !is.na(mean_invs) & !is.na(sliced_ltc) & !is.na(sliced_vocc) & !is.na(mean_nuts)) %>% mutate(scaled_invs = (mean_invs * 10^-3)) %>% select(Duration, SppR1, scaled_invs, mean_nuts, sliced_ltc, sliced_vocc) %>% cor(., use = 'complete.obs')


global_full_no_vocc <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = fl_combined %>% mutate(scaled_invs = (mean_invs * 10^-3)), 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (scaled_invs*sliced_ltc + mean_nuts)
)
global_full_no_vocc

global_full_no_ltc <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = fl_combined %>% mutate(scaled_invs = (mean_invs * 10^-3)), 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (scaled_invs + sliced_vocc + mean_nuts)
)
global_full_no_ltc

data_frame(parameter = rownames(global_full_no_vocc$b), 
           no_vocc_percent = round(as.vector(get_percent_change(global_full_no_vocc$b)), digits = 4), 
           no_vocc_pval = round(global_full_no_vocc$pval, digits = 4))) %>%
  left_join(., data_frame(parameter = rownames(global_full_no_ltc$b), 
                         no_ltc_percent = round(as.vector(get_percent_change(global_full_no_ltc$b)), digits = 4), 
                         no_ltc_pval = round(global_full_no_ltc$pval, digits = 4))) %>%
pandoc.table(.)

```


### Attempt with the full interaction models: Duration*(I + VOCC + I*L + LTC - N +I*N + L*N)

The full interaction models do not converge when we use the weighted meta-regression. They do converge for the full model 

```{r, eval = FALSE}

global_ne_all_interactions <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = no_event %>% mutate(scaled_invs = (mean_invs * 10^-3)), 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (scaled_invs + scaled_invs*sliced_ltc + sliced_ltc + mean_nuts + scaled_invs*mean_nuts + sliced_ltc*mean_nuts)
)
global_ne_all_interactions

global_all_interactions <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = fl_combined %>% mutate(scaled_invs = mean_invs * 10^-3), 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (scaled_invs + scaled_invs*sliced_ltc + sliced_ltc + mean_nuts + scaled_invs*mean_nuts + sliced_ltc*mean_nuts)
)
global_all_interactions

```

```{r}

global_all_invs_ltc_interaction <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = fl_combined %>% mutate(scaled_invs = mean_invs * 10^-3), 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (scaled_invs + scaled_invs*sliced_ltc + sliced_ltc + mean_nuts)
)
global_all_invs_ltc_interaction


global_ne_all_interactions_lme <- 
  lmer(yi_SppR_ROM ~ Duration * (scaled_invs + sliced_vocc + scaled_invs*sliced_ltc + sliced_ltc + mean_nuts + scaled_invs*mean_nuts + sliced_ltc*mean_nuts) + (1 | Study.ID),
      data = no_event %>% mutate(scaled_invs = mean_invs * 10^-3), na.action = na.omit)
summary(global_ne_all_interactions_lme)

global_all_interactions_lme <- 
  lme(yi_SppR_ROM ~ Duration * (mean_invs + mean_vocc + mean_invs*mean_lin_change + mean_lin_change + mean_nuts + mean_invs*mean_nuts + mean_lin_change*mean_nuts), 
      random = ~ 1 | factor(Study.ID),
      data = fl_combined, na.action = na.omit)
summary(global_all_interactions_lme)


global_all_invs_ltc_interaction_lme <- 
  lme(yi_SppR_ROM ~ Duration * (mean_invs + mean_vocc + mean_invs*mean_lin_change + mean_lin_change + mean_nuts), 
      random = ~ 1 | factor(Study.ID),
      data = fl_combined, na.action = na.omit)
summary(global_all_invs_ltc_interaction_lme)

```

Key for the table: 

* rma_interact_change = variance weighted analysis with the full dataset, with the following model: LR ~ Duration * (I + V + I*LTC + LTC + N)

* all_full_interact_change = unweighted analysis with the full dataset, with the following model: LR ~ Duration * (I + V + I*LTC + LTC + N + I*N + LTC*N)

* all_invs_ltc_int_change = unweighted analysis with the full dataset, with the following model: LR ~ Duration * (I + V + I*LTC + LTC + N)

```{r}
data_frame(parameter = rownames(global_all_invs_ltc_interaction$b), 
           rma_interact_change  = round(as.vector(get_percent_change(global_all_invs_ltc_interaction$b)), digits = 4), 
           rma_interact_pval  = round(global_all_invs_ltc_interaction$pval, digits = 4)
           ) %>% 
  left_join(., data_frame(parameter = rownames(summary(global_all_interactions_lme)$tTable), 
                         all_full_interact_change = round(as.vector(get_percent_change(summa, digits = 4ry(global_all_interactions_lme)$tTable[, 1]))), 
                         all_full_interact_pval = round(as.vector(summary(global_all_interactions_lme)$tTable[, 5]), digits = 4))) %>%
  left_join(., data_frame(parameter = rownames(summary(global_all_invs_ltc_interaction_lme)$tTable), 
                         all_invs_ltc_int_change = round(as.vector(get_percent_change(summa, digits = 4ry(global_all_invs_ltc_interaction_lme)$tTable[, 1]))), 
                         all_invs_ltc_int_pval = round(as.vector(summary(global_all_invs_ltc_interaction_lme)$, digits = 4tTable[, 5])))) %>% 
pandoc.table(.)

```

### Including initial species richness

In our predictions we have assumed that climate velocity is likely to lead to an influx of species into initially, relatively depauperate regions. We can include this assumption by including an interaction between initial species richness and mean climate velocity. We do not include this interaction with the other drivers because it is less clear how initial species richness will alter the effects of linear changes in temperature (too high too fast should result in loss regardless of the initial number of species), it is equivocal in the literature how invasive species relates to species richness (conflicting evidence), and nutrients (need to check, but I think just general declines in the long term? - e.g., paradox of enrichment?).  

Jillian''s reasoning for initial species richness interactions:

1. SppR1 * Invs - I do not think this should be included. In the literature, the relationship between initial diversity and invasives is equivocal. I think that this relationship is likely too context dependent to meaningfully include it in the model.

2. SppR1 * VOCC - loss is likely to be higher in low diversity (likely polar) locations where species are closer to thermal tolerances and this also accounts for the idea of poleward range expansions from species rich to depauperate areas.

3. SppR1 * LTC - same as VOCC. - probably need a better explanation/support

4. SppR1 * Nuts - may expect a non-linear relationship because more diverse systems may have a higher capacity to buffer nutrients (at least in the short term). (e.g., "Biodiversity improves water quality through niche partitioning" - Cardinale 2011 )

How much do we need to be concerned that the log ratio calculation includes SppR1? Does this matter if we are taking a predictive approach? Because if SppR1 is valuable as a predictor then the mechanism for why shouldn''t matter.



```{r}

initial_richness_ne <- 

    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = no_event %>% mutate(scaled_invs = mean_invs * 10^-3), 
          random = ~ 1 | Study.ID, 
    #      control=list(verbose = TRUE),
          mods = ~ Duration * (scaled_invs + sliced_ltc + mean_nuts) * SppR1
)

initial_richness_ne

initial_richness_all <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = fl_combined %>% mutate(scaled_invs = mean_invs * 10^-3), 
          random = ~ 1 | Study.ID, 
          control=list(verbose = TRUE),
          mods = ~ Duration * (sliced_vocc + mean_nuts + scaled_invs) * SppR1
)
initial_richness_all

initial_richness_all <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = fl_combined, 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (sliced_ltc + mean_nuts + mean_invs) * SppR1
)
initial_richness_all



# Unweighted analysis
initial_richness_all_lme <-
lmer(yi_SppR_ROM ~ Duration * SppR1 * (sliced_vocc + mean_nuts + scaled_invs) + (1 | Study.ID), data = fl_combined %>% mutate(scaled_invs = mean_invs * 10^-3) %>% mutate(Study.ID = as.factor(Study.ID)), na.action = 'na.omit')
summary(initial_richness_all_lme)

initial_richness_ne_lme <- 
  lme(yi_SppR_ROM ~ Duration * SppR1 * (sliced_vocc + mean_nuts + mean_invs), 
      random = ~ 1 | factor(Study.ID),
      data = no_event, na.action = na.omit)
summary(initial_richness_ne_lme)

initial_richness_all_lme <- 
  lme(yi_SppR_ROM ~ Duration * SppR1 * (sliced_vocc + sliced_ltc + mean_nuts + scaled_invs), 
      random = ~ 1 | factor(Study.ID),
      data = fl_combined %>% mutate(scaled_invs = mean_invs * 10^-3), na.action = na.omit)
summary(initial_richness_all_lme)

```

#### Issues with including initial richness as a predictor
Do these results suggest that 

```{r}

x1 <- sample(na.omit(fl_combined$SppR1), size = 708, replace = FALSE)

x2 <- sample(na.omit(fl_combined$SppR2), size = 708, replace = FALSE)

test <- data.frame(ROM = log(x2 / x1), initial = x1)

plot(test$ROM ~ test$initial)

```


### Analysis without interactions between drivers

There is no effect of velocity of climate change in the subset of the data that does not have an event, but there is a negative effect in the long term when looking at the full dataset.


```{r}

global_ne <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = no_event, 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (SppR1*mean_vocc + mean_lin_change + mean_invs +  mean_nuts)
)
global_ne

global_all <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = fl_combined, 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (mean_vocc + mean_invs +  mean_nuts)
)
global_all
```

The unweighted analyses of velocity of climate change, invasives, and nutrients show no significant relationships. 

```{r}
global_lme_ne <- 
  lme(yi_SppR_ROM ~ Duration * (mean_vocc + mean_invs +  mean_nuts), random = ~ 1 | factor(Study.ID),
      data = no_event, na.action = na.omit)
summary(global_lme_ne)

global_lme3 <- 
  lme(yi_SppR_ROM ~ Duration * (mean_vocc + mean_invs +  mean_nuts), random = ~ 1 | factor(Study.ID),
      data = fl_combined, na.action = na.omit)
summary(global_lme3)
```


Study specific slices using rma() and the linear change fails. 

```{r, eval=FALSE}
# optimization error - unclear why this is happening
global4 <- 
filter(fl_combined, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & 
                     vi_SppR_ROM > 0 & !is.na(mean_imps)) %>%
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = ., 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (single_lin_change + mean_invs +  mean_nuts)
)
global4

global4 <- 
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = no_event, 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (single_lin_change + mean_invs +  mean_nuts)
)
global4
```

However, the unweighted analyses for linear temperature change do not fail, but show no effect of the moderators: linear temperature change, invasives, and nutrients. The unweighted analyses that include climate velocity instead of linear temperature change do not show an effect of the moderators. 

```{r}  
# Unweighted
# Linear temperature change
global_lme_ne <- 
  lme(yi_SppR_ROM ~ Duration * (single_lin_change + mean_invs +  mean_nuts), random = ~ 1 | factor(Study.ID),
      data = no_event, na.action = na.omit)
summary(global_lme_ne)

global_lme_all <- 
  lme(yi_SppR_ROM ~ Duration * (single_lin_change + mean_invs +  mean_nuts), random = ~ 1 | factor(Study.ID),
      data = fl_combined, na.action = na.omit)
summary(global_lme_all)

# Unweighted
# VOCC
global_lme_ne <- 
  lme(yi_SppR_ROM ~ Duration * (single_vel + mean_invs +  mean_nuts), random = ~ 1 | factor(Study.ID),
      data = no_event, na.action = na.omit)
summary(global_lme_ne)

global_lme_all <- 
  lme(yi_SppR_ROM ~ Duration * (single_vel + mean_invs +  mean_nuts), random = ~ 1 | factor(Study.ID),
      data = fl_combined, na.action = na.omit)
summary(global_lme_all)

```


But looking at the climate velocities instead of linear temperature change, the rma() models work, but there is no temperature signal.


```{r}
global_ne <- 
filter(no_event, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & 
                     vi_SppR_ROM > 0 & !is.na(mean_imps)) %>%
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = ., 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (single_vel + mean_invs +  mean_nuts)
)
global_ne


global_all <- 
filter(fl_combined, !is.na(yi_SppR_ROM) & !is.na(vi_SppR_ROM) & 
                     vi_SppR_ROM > 0 & !is.na(mean_imps)) %>%
    rma.mv(yi = yi_SppR_ROM, V = vi_SppR_ROM,
          data = ., 
          random = ~ 1 | Study.ID, 
          mods = ~ Duration * (single_vel + mean_invs +  mean_nuts)
)
global_all

#global_summ_df <- 
#  mk_rma_summary_df(fl_combined, rma_object = global2)
```

